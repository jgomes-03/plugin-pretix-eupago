Metadata-Version: 2.4
Name: pretix-eupago
Version: 1.0
Summary: EuPago payment provider for pretix
Home-page: https://github.com/jgomes-03/plugin-pretix-eupago
Author: Jorge Gomes
Author-email: jorge.gomes211@gmail.com
License: Proprietary
License-File: LICENSE
Requires-Dist: requests>=2.20.0
Requires-Dist: pycryptodome>=3.15.0
Dynamic: author
Dynamic: author-email
Dynamic: description
Dynamic: home-page
Dynamic: license
Dynamic: license-file
Dynamic: requires-dist
Dynamic: summary

# EuPago Integration Payment Provider - Pretix
## Vers√£o 1.0

Este plugin fornece integra√ß√£o completa e moderna com os m√©todos de pagamento EuPago para o sistema Pretix, incluindo suporte completo para Webhooks 2.0 com encripta√ß√£o AES-256-CBC e uma interface de utilizador melhorada.

## √çndice
- [M√©todos de Pagamento Suportados](#m√©todos-de-pagamento-suportados)
- [Funcionalidades](#funcionalidades)
- [Dete√ß√£o Autom√°tica de Estado de Pagamento](#dete√ß√£o-autom√°tica-de-estado-de-pagamento)
- [Instala√ß√£o](#instala√ß√£o)
  - [Instala√ß√£o Local](#instala√ß√£o-local)
  - [Instala√ß√£o em Contentor](#instala√ß√£o-em-contentor)
- [Configura√ß√£o](#configura√ß√£o)
- [MBWay - Experi√™ncia de Utilizador Melhorada](#mbway---experi√™ncia-de-utilizador-melhorada)
- [Arquitetura de Webhooks](#arquitetura-de-webhooks)
- [Monitoriza√ß√£o e Depura√ß√£o](#monitoriza√ß√£o-e-depura√ß√£o)
- [Fluxo de Pagamento](#fluxo-de-pagamento)
- [Registo de Altera√ß√µes](#registo-de-altera√ß√µes)
- [Licen√ßa](#licen√ßa)

## M√©todos de Pagamento Suportados

### üÜï **Novos M√©todos (com Configura√ß√£o Dedicada)**
- **MB and Credit Card (EuPago)** - M√©todo unificado para MB e Cart√£o de Cr√©dito com API key e webhook secret dedicados
- **MBWay (EuPago)** - Nova implementa√ß√£o MBWay com configura√ß√£o dedicada

### üìö **M√©todos Legacy (Configura√ß√£o Partilhada)**
- **Pagamento Online (Legacy)** - M√©todo PayByLink original (mantido para compatibilidade)
- **Credit Card (EuPago)** - Pagamentos diretos com cart√£o atrav√©s da EuPago
- **MBWay (Legacy)** - M√©todo de pagamento m√≥vel original
- **Multibanco (EuPago)** - Refer√™ncias Multibanco tradicionais para transfer√™ncia banc√°ria
- **PayShop (EuPago)** - Pagamentos em numer√°rio atrav√©s da rede PayShop

> **Nota**: Os novos m√©todos permitem configura√ß√µes separadas (API key e webhook secret) para melhor organiza√ß√£o e seguran√ßa. Consulte [NEW_PAYMENT_METHODS.md](NEW_PAYMENT_METHODS.md) para detalhes completos.

## Funcionalidades

### ‚ú® **Novidades na v2.0**
- üîë **Configura√ß√µes Dedicadas** - Cada m√©todo de pagamento pode ter API key e webhook secret pr√≥prios
- üÜï **Novos M√©todos de Pagamento** - MB and Credit Card e MBWay com configura√ß√£o separada
- üìã **Melhor Organiza√ß√£o** - Separa√ß√£o clara entre m√©todos novos e legacy
- üîê **Seguran√ßa Melhorada** - Webhook secrets dedicados para cada m√©todo de pagamento
- üîÑ **Compatibilidade Completa** - Todos os m√©todos existentes continuam a funcionar

### ‚ú® **Funcionalidades v1.0 (Mantidas)**
- üîê **Webhooks 2.0 com Encripta√ß√£o** - Suporte completo para webhooks encriptados AES-256-CBC
- üé® **Interface Moderna** - Templates redesenhados com melhor UX/UI
- üßπ **Logs Otimizados** - Sistema de logging limpo e eficiente
- ‚úÖ **Valida√ß√£o de Assinatura** - Implementa√ß√£o correta segundo documenta√ß√£o oficial EuPago
- üì± **MBWay Melhorado** - Interface simplificada e mais responsiva

### üöÄ **Funcionalidades Principais**
- ‚úÖ **Suporte multi-m√©todo** - Todos os 4 m√©todos de pagamento EuPago
- ‚úÖ **Webhooks em tempo real** - Dete√ß√£o e atualiza√ß√µes autom√°ticas do estado de pagamento
- ‚úÖ **Interface melhorada** - Templates modernos com melhor formata√ß√£o e √≠cones
- ‚úÖ **Consulta de estado API** - Mecanismo de reserva para webhooks perdidos
- ‚úÖ **Sandbox/Produ√ß√£o** - Suporte completo ao ambiente de testes
- ‚úÖ **Tratamento de erros** - Gest√£o e registo de erros abrangente
- ‚úÖ **Seguran√ßa** - Valida√ß√£o de assinatura webhook e processamento seguro
- ‚úÖ **Ferramentas de monitoriza√ß√£o** - Comandos de gest√£o para verifica√ß√£o do estado de pagamento
- ‚úÖ **Responsivo para dispositivos m√≥veis** - Otimizado para pagamentos m√≥veis
- ‚úÖ **Internacionaliza√ß√£o** - Suporte multi-idioma (PT/EN)

## Dete√ß√£o Autom√°tica de Estado de Pagamento

Este plugin deteta automaticamente quando os pagamentos s√£o conclu√≠dos e atualiza o seu estado no pretix utilizando:

### M√©todo Prim√°rio: Webhooks
- **Notifica√ß√µes em tempo real** da EuPago quando o estado do pagamento muda
- **Atualiza√ß√µes imediatas** - estado de pagamento atualizado segundos ap√≥s a conclus√£o
- **Valida√ß√£o segura** utilizando verifica√ß√£o de assinatura HMAC-SHA256 (implementa√ß√£o correta na v2.0.0)
- **Suporte completo para Webhooks 2.0** com encripta√ß√£o AES-256-CBC
- **Todos os m√©todos de pagamento suportados** (MBWay, Cart√£o de Cr√©dito, Multibanco, PayShop)

### M√©todo de Reserva: Consulta API  
- **Mecanismo de reserva** para webhooks perdidos
- **Comandos de gest√£o** para verifica√ß√£o do estado de pagamento
- **Monitoriza√ß√£o automatizada** via cron jobs (opcional)
- **Verifica√ß√£o manual do estado** para resolu√ß√£o de problemas

## Instala√ß√£o

### Instala√ß√£o Local

1. Clone ou copie o plugin para o diret√≥rio de plugins Pretix:
```bash
# Navegue at√© ao diret√≥rio de plugins Pretix
cd /path/to/pretix/src/pretix/plugins

# Clone ou copie o plugin eupago
cp -r /path/to/eupago ./

# Instale em modo de desenvolvimento
cd eupago
pip install -e .
```

2. Adicione o plugin √† configura√ß√£o do Pretix (`pretix.cfg`):
```ini
[pretix]
plugins = eupago

[locale]
timezone = Europe/Lisbon
```

3. Reinicie o servidor Pretix
```bash
# Reinicie o servidor
systemctl restart pretix-web pretix-worker
```

### Instala√ß√£o em Contentor

Se estiver a utilizar o Pretix num ambiente Docker:

1. Adicione o plugin ao seu `Dockerfile` personalizado:
```Dockerfile
FROM pretix/standalone:latest
USER root
WORKDIR /pretix/src
RUN pip3 install pretix-eupago==1.1.0
USER pretixuser
```

2. Reconstrua e reinicie os seus contentores:
```bash
docker-compose build
docker-compose up -d
```

Ou utilizando o script de instala√ß√£o:

```bash
# Usar o script install.sh para instala√ß√£o automatizada
./install.sh production
```

## Configura√ß√£o

### Configura√ß√µes Obrigat√≥rias
- **API Key** - Chave da API fornecida pela EuPago
- **Endpoint** - Escolha sandbox (teste) ou live (produ√ß√£o)

### Configura√ß√µes Opcionais
- **Webhook Secret** - Para seguran√ßa melhorada (recomendado para produ√ß√£o)
  - O segredo deve ser configurado nas configura√ß√µes do organizador como `payment_eupago_webhook_secret`
  - Alternativamente, pode ser definido como vari√°vel de ambiente `EUPAGO_WEBHOOK_SECRET`
- **Client ID/Secret** - Se estiver a utilizar autentica√ß√£o OAuth

### Configura√ß√£o de Webhook
Os webhooks s√£o configurados automaticamente quando os pagamentos s√£o criados. N√£o √© necess√°ria configura√ß√£o manual de webhook!

**Formato da URL do Webhook**: `https://seudominio.com/seuevento/eupago/webhook/`

## MBWay - Experi√™ncia de Utilizador Melhorada

O m√©todo de pagamento MBWay inclui uma **p√°gina de temporizador interativa** que proporciona uma excelente experi√™ncia ao utilizador:

### üéØ Funcionalidades do Temporizador
- **Contagem regressiva de 5 minutos** com barra de progresso visual
- **Verifica√ß√£o de estado em tempo real** a cada 3 segundos
- **Redirecionamento autom√°tico** quando o pagamento √© confirmado
- **Interface otimizada para dispositivos m√≥veis** perfeita para pagamentos por telem√≥vel

### üì± Fluxo do Utilizador
1. Cliente seleciona MBWay e introduz o n√∫mero de telem√≥vel
2. **√â redirecionado para a p√°gina do temporizador** com contagem regressiva e instru√ß√µes
3. Cliente recebe notifica√ß√£o MBWay no telem√≥vel
4. Cliente confirma pagamento na aplica√ß√£o MBWay
5. **A p√°gina deteta automaticamente** a confirma√ß√£o e redireciona para a encomenda

### üîÑ Dete√ß√£o de Estado
- **Prim√°rio**: Webhooks em tempo real da EuPago
- **Secund√°rio**: Consulta JavaScript a cada 3 segundos
- **Reserva**: Bot√µes de verifica√ß√£o manual de estado

## Arquitetura de Webhooks

### Abordagem Recomendada: Webhook √önico e Global

**URL:** `https://seu-site.com/_eupago/webhook/`

#### Vantagens:
- **Simplicidade**: Uma √∫nica URL para configurar
- **Escalabilidade**: Funciona para m√∫ltiplos organizadores
- **Manuten√ß√£o**: Mais f√°cil de gerir e depurar
- **Conformidade**: Alinhado com as melhores pr√°ticas da EuPago

#### Como Funciona:
1. EuPago envia webhook para URL global
2. Plugin identifica o pagamento pelo `identifier` ou `reference`
3. Plugin encontra o organizador correto automaticamente
4. Processa o pagamento independentemente do evento/organizador

## Monitoriza√ß√£o e Depura√ß√£o

### Comandos de Gest√£o

Utilize os seguintes comandos para monitorizar e verificar pagamentos:

```bash
# Verificar estado de todos os pagamentos EuPago recentes
python manage.py eupago_check_payments

# Verificar estado de um pagamento espec√≠fico
python manage.py eupago_check_payment --reference REF123456
```

### Cron Jobs para Monitoriza√ß√£o Autom√°tica

Configure cron jobs para verificar automaticamente pagamentos pendentes:

```
# Exemplo de crontab - verificar pagamentos a cada 30 minutos
*/30 * * * * cd /path/to/pretix && python manage.py eupago_check_payments --status=pending
```

## Fluxo de Pagamento

### Fluxo Geral
1. Cliente seleciona m√©todo de pagamento EuPago
2. Plugin faz chamada √† API da EuPago para criar pagamento
3. Cliente completa pagamento (depende do m√©todo)
4. EuPago notifica o Pretix via webhook sobre altera√ß√£o de estado
5. Plugin processa webhook e marca pagamento como completo
6. Cliente √© redirecionado para p√°gina de sucesso

### Fluxo do Cart√£o de Cr√©dito
1. Cliente seleciona pagamento por cart√£o de cr√©dito
2. Cliente √© redirecionado para p√°gina de pagamento segura da EuPago
3. Cliente introduz dados do cart√£o e completa pagamento
4. EuPago processa o pagamento e notifica o Pretix
5. Cliente √© redirecionado de volta ao Pretix

### Fluxo do MBWay
1. Cliente seleciona MBWay e introduz n√∫mero de telem√≥vel
2. Plugin cria solicita√ß√£o MBWay via API EuPago
3. Cliente √© redirecionado para p√°gina de temporizador
4. Cliente recebe notifica√ß√£o MBWay no telem√≥vel para aprovar
5. Ap√≥s aprova√ß√£o, EuPago envia webhook de confirma√ß√£o
6. Cliente √© automaticamente redirecionado para p√°gina de sucesso

### Fluxo do Multibanco/PayShop
1. Cliente seleciona m√©todo de pagamento
2. Plugin gera refer√™ncia de pagamento via API EuPago
3. Refer√™ncia √© apresentada ao cliente
4. Cliente completa pagamento (banco/PayShop)
5. EuPago deteta pagamento e notifica o Pretix via webhook
6. Encomenda √© marcada como paga

## Registo de Altera√ß√µes

### v1.0 - Interface Moderna e Webhooks 2.0 (Setembro 2025)
#### üé® **Melhorias de Interface**
- **Templates redesenhados** com interface moderna e √≠cones FontAwesome
- **Multibanco** - Refer√™ncias com melhor formata√ß√£o visual e c√≥digos de cor
- **PayShop** - Layout otimizado com instru√ß√µes passo-a-passo claras
- **MBWay** - Interface simplificada e mais responsiva
- **Mensagens melhoradas** - Alertas informativos e instru√ß√µes mais claras

#### üîê **Webhooks 2.0 e Seguran√ßa**
- **Suporte completo Webhooks 2.0** - Encripta√ß√£o AES-256-CBC
- **Valida√ß√£o de assinatura corrigida** - Implementa√ß√£o exata da documenta√ß√£o oficial EuPago
- **Decripta√ß√£o autom√°tica** - Processamento seguro de payloads encriptados
- **Processamento melhorado** - Extra√ß√£o correta de dados de transa√ß√£o aninhados

#### üßπ **Optimiza√ß√µes T√©cnicas**
- **Sistema de logging otimizado** - Remo√ß√£o de logs verbosos desnecess√°rios
- **Performance melhorada** - C√≥digo mais limpo e eficiente
- **Debugging inteligente** - Logs essenciais mantidos, ru√≠do removido
- **Estabilidade aumentada** - Corre√ß√µes de bugs cr√≠ticos

### v0.1 a v0.4 - Alpha
- Melhorias na p√°gina de temporizador MBWay
- Otimiza√ß√£o da valida√ß√£o de webhook
- Corre√ß√µes de erros no processamento de cart√£o de cr√©dito
- Renomea√ß√£o de eupago_v2 para eupago
- Tradu√ß√£o da documenta√ß√£o para Portugu√™s de Portugal

### Vers√µes anteriores
- Reescrita completa do plugin
- Suporte para todos os m√©todos de pagamento EuPago
- Implementa√ß√£o de webhook robusta
- Integra√ß√£o melhorada com o Pretix

## Licen√ßa

Licenciado sob licen√ßa propriet√°ria. Ver arquivo LICENSE para detalhes.

## Gest√£o de Vers√µes

A vers√£o do plugin √© definida uma √∫nica vez no ficheiro `eupago/apps.py` na vari√°vel `__version__`. Quando atualizar a vers√£o, execute o script `update_version.ps1` (Windows) ou `update_version.sh` (Linux/Mac) para sincronizar a vers√£o em todos os ficheiros do projeto.

```bash
# Linux/Mac
./update_version.sh

# Windows
.\update_version.ps1
```

Este script atualiza a vers√£o no README.md e outros ficheiros relevantes, e opcionalmente cria uma tag git com a nova vers√£o.

## Setting up Webhook Security

For secure webhook processing, you should configure the webhook secret key. This can be done in two ways:

1. **Through Pretix Organizer Settings (Recommended)**
   - Go to Organizer Settings in the Pretix admin panel
   - Navigate to the EuPago plugin settings
   - Enter your webhook secret in the "Webhook Secret" field
   - Save your settings

2. **Using Environment Variables**
   - Set the environment variable `EUPAGO_WEBHOOK_SECRET` in your server configuration:
   ```bash
   export EUPAGO_WEBHOOK_SECRET='your_secret_here'
   ```

The webhook secret is used to:
- Validate webhook signature authentication
- Decrypt encrypted webhook data (when using EuPago Webhooks 2.0)

For maximum security, use a strong random string as your webhook secret. You should set the same secret in both your Pretix configuration and your EuPago account.
